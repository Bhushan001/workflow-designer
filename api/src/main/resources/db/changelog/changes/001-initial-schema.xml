<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <changeSet id="001-create-workflow-table" author="workflow-designer">
        <createTable tableName="workflows">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="updated_by" type="VARCHAR(255)"/>
        </createTable>
        
        <createIndex indexName="idx_workflows_name" tableName="workflows">
            <column name="name"/>
        </createIndex>
        
        <createIndex indexName="idx_workflows_created_at" tableName="workflows">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-create-workflow-nodes-table" author="workflow-designer">
        <createTable tableName="workflow_nodes">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="workflow_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="label" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="position_x" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="position_y" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="config" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex indexName="idx_nodes_workflow_id" tableName="workflow_nodes">
            <column name="workflow_id"/>
        </createIndex>
        
        <createIndex indexName="idx_nodes_type" tableName="workflow_nodes">
            <column name="type"/>
        </createIndex>
        
        <addForeignKeyConstraint
                baseTableName="workflow_nodes"
                baseColumnNames="workflow_id"
                constraintName="fk_nodes_workflow"
                referencedTableName="workflows"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="003-create-workflow-edges-table" author="workflow-designer">
        <createTable tableName="workflow_edges">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="workflow_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="source_node_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="target_node_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="source_handle" type="VARCHAR(255)"/>
            <column name="target_handle" type="VARCHAR(255)"/>
            <column name="label" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex indexName="idx_edges_workflow_id" tableName="workflow_edges">
            <column name="workflow_id"/>
        </createIndex>
        
        <createIndex indexName="idx_edges_source" tableName="workflow_edges">
            <column name="source_node_id"/>
        </createIndex>
        
        <createIndex indexName="idx_edges_target" tableName="workflow_edges">
            <column name="target_node_id"/>
        </createIndex>
        
        <createIndex indexName="idx_edges_source_target" tableName="workflow_edges">
            <column name="source_node_id"/>
            <column name="target_node_id"/>
        </createIndex>
        
        <addForeignKeyConstraint
                baseTableName="workflow_edges"
                baseColumnNames="workflow_id"
                constraintName="fk_edges_workflow"
                referencedTableName="workflows"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
        
        <addForeignKeyConstraint
                baseTableName="workflow_edges"
                baseColumnNames="source_node_id"
                constraintName="fk_edges_source"
                referencedTableName="workflow_nodes"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
        
        <addForeignKeyConstraint
                baseTableName="workflow_edges"
                baseColumnNames="target_node_id"
                constraintName="fk_edges_target"
                referencedTableName="workflow_nodes"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="004-create-workflow-executions-table" author="workflow-designer">
        <createTable tableName="workflow_executions">
            <column name="id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="workflow_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="started_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP"/>
            <column name="error_message" type="TEXT"/>
            <column name="created_by" type="VARCHAR(255)"/>
        </createTable>
        
        <createIndex indexName="idx_executions_workflow_id" tableName="workflow_executions">
            <column name="workflow_id"/>
        </createIndex>
        
        <createIndex indexName="idx_executions_status" tableName="workflow_executions">
            <column name="status"/>
        </createIndex>
        
        <createIndex indexName="idx_executions_started_at" tableName="workflow_executions">
            <column name="started_at"/>
        </createIndex>
        
        <addForeignKeyConstraint
                baseTableName="workflow_executions"
                baseColumnNames="workflow_id"
                constraintName="fk_executions_workflow"
                referencedTableName="workflows"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="005-create-workflow-execution-results-table" author="workflow-designer">
        <createTable tableName="workflow_execution_results">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="execution_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="node_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="outputs" type="TEXT"/>
            <column name="error_message" type="TEXT"/>
            <column name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex indexName="idx_results_execution_id" tableName="workflow_execution_results">
            <column name="execution_id"/>
        </createIndex>
        
        <createIndex indexName="idx_results_node_id" tableName="workflow_execution_results">
            <column name="node_id"/>
        </createIndex>
        
        <createIndex indexName="idx_results_status" tableName="workflow_execution_results">
            <column name="status"/>
        </createIndex>
        
        <addForeignKeyConstraint
                baseTableName="workflow_execution_results"
                baseColumnNames="execution_id"
                constraintName="fk_results_execution"
                referencedTableName="workflow_executions"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
        
        <addForeignKeyConstraint
                baseTableName="workflow_execution_results"
                baseColumnNames="node_id"
                constraintName="fk_results_node"
                referencedTableName="workflow_nodes"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

</databaseChangeLog>

